use picky_asn1_der::{Asn1RawDer};
use picky_asn1::wrapper::{Asn1SetOf, ApplicationTag0, ApplicationTag1, Implicit, ObjectIdentifierAsn1, HeaderOnly};
use serde_derive::{ Serialize, Deserialize };

#[cfg(test)]
mod tests {
    use crate::pdf_signature::PDFSignature;
    use picky_asn1_der::from_bytes;

    #[test]
    fn exploration() {

        let signature = "30820810020101310F300D06096086480165030402010500300B06092A864886F70D010701A0820596308205923082037AA00302010202040D963E7E300D06092A864886F70D01010B050030819D310B300906035504061302415431483046060355040A0C3F412D5472757374204765732E20662E20536963686572686569747373797374656D6520696D20656C656B74722E20446174656E7665726B65687220476D62483121301F060355040B0C18612D7369676E2D7072656D69756D2D6D6F62696C652D30353121301F06035504030C18612D7369676E2D7072656D69756D2D6D6F62696C652D3035301E170D3138303231393139323330375A170D3233303231393139323330375A305E310B30090603550406130241543116301406035504030C0D53696D6F6E2050656C65736B613110300E06035504040C0750656C65736B61310E300C060355042A0C0553696D6F6E311530130603550405130C3334383537313730303431313059301306072A8648CE3D020106082A8648CE3D030107034200045871A1D008786F3CCD62D28A340D26908A9A3D3E53C56E01E2B9F3692422DA02D804588842B329AED1B7FE7AD0512473F5918BB388EA74441E2155F2AC84B2BCA38201E1308201DD307D06082B060105050701010471306F304406082B060105050730028638687474703A2F2F7777772E612D74727573742E61742F63657274732F612D7369676E2D7072656D69756D2D6D6F62696C652D30352E637274302706082B06010505073001861B687474703A2F2F6F6373702E612D74727573742E61742F6F63737030130603551D23040C300A800848F3FD9C230E8777307206082B0601050507010304663064300A06082B06010505070B023008060604008E4601013008060604008E4601043013060604008E4601063009060704008E46010601302D060604008E46010530233021161B68747470733A2F2F7777772E612D74727573742E61742F7064732F1302454E30110603551D0E040A040843DEC51B19D77BCB300E0603551D0F0101FF0404030206C030090603551D130402300030600603551D20045930573008060604008B300101304B06062A28001101143041303F06082B060105050702011633687474703A2F2F7777772E612D74727573742E61742F646F63732F63702F612D7369676E2D7072656D69756D2D6D6F62696C6530430603551D1F043C303A3038A036A0348632687474703A2F2F63726C2E612D74727573742E61742F63726C2F612D7369676E2D7072656D69756D2D6D6F62696C652D3035300D06092A864886F70D01010B0500038202010007C9E2C763F4D81E26CFF947CD9EEC2B42C857004C0F4CC8388DB38C6B3E1692E3611E1157964B7EBF29BB6BBC87B9D7D8E35DF5411E0B7CE21331223A84DBB930DC9D475FCAE27B0E25E3075E913F565C2DD863F9557DD5AEB2C4C55503FAA03F75DF6B0993A4F07F1BF35019A52DED05A439E70B2D03054216BB0C04F79A4464CB405336A45E8496BA1A97425843769FE4405F98159B126851E75A102F59654782911B70DA04579CB48BC52AE6FD5C8C1098417902E881555CC76177D4C501865BA560D206F5E50990B1725C4B20F1BE1A0D265A84959B292E1C286F6B4E1DE2AD1AE90791F9AAD1153201566FC9AFBAF3500E3DAAA51B2F9EAD8B5360FF1C85040F990FE9B3DBCAD2F0A69C68FF819232EE4FE918C489C36D0659F34338A4BAD7D47685FD39EC2A5DC137D5530BF8AB3C527705A155AD67C88339B82D3780C99D2659ED5A3EBDE2E9E6680334EF7F891FEDE5CA294B2A9EC3ADF4DE469FDB29C445E88C1F71CE92FFCD00488865B724B94D91F633A7E5A476BC857264520E8953A5DB4F3A0EC1AB37C0C34D12675BE699EC98DA09A5A4E3C2A48BA8283AEA18909E6DA8900B41035580457E0BF5B1E12D459B0ADE559C24039798D0FC64FD6EFD39FE7F094D2E66CD7EB1C3E239236845206168E4BB04B5D6EC1F85DBDD6ABE7A7745BE8ABE911602EC55F34F5E7459CF6A70A9EB95113A04579524B7D295318202513082024D0201013081A630819D310B300906035504061302415431483046060355040A0C3F412D5472757374204765732E20662E20536963686572686569747373797374656D6520696D20656C656B74722E20446174656E7665726B65687220476D62483121301F060355040B0C18612D7369676E2D7072656D69756D2D6D6F62696C652D30353121301F06035504030C18612D7369676E2D7072656D69756D2D6D6F62696C652D303502040D963E7E300D06096086480165030402010500A0820138301806092A864886F70D010903310B06092A864886F70D010701302F06092A864886F70D0109043122042065C0B57CC178C9CDC88901B0E3A5870B6B61A6037E8E97578533983DBE93191B3081EA060B2A864886F70D010910022F3181DA3081D73081D43081D10420D1ECAD25AF078947BBD3BB9ED7BD0B51320FB789A5D6FFF12D6777456476E12A3081AC3081A3A481A030819D310B300906035504061302415431483046060355040A0C3F412D5472757374204765732E20662E20536963686572686569747373797374656D6520696D20656C656B74722E20446174656E7665726B65687220476D62483121301F060355040B0C18612D7369676E2D7072656D69756D2D6D6F62696C652D30353121301F06035504030C18612D7369676E2D7072656D69756D2D6D6F62696C652D303502040D963E7E300C06082A8648CE3D04030205000446304402200214B0D7972BA69EC457517E33F7AA49EEB7975A2C7D629F023E22ADAC6FD47402201DD2F372C3A26C60A0EC9346DBDB3789C8B7644F6A0AB68EC6C71D38C785D1BB0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        let _pdf_signature: PDFSignature = from_bytes(hex::decode(signature.to_string()).unwrap().as_slice()).unwrap();
    }
}


#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
pub(crate) struct PDFSignature {
    pub object_identifier: ObjectIdentifierAsn1,
    pub signed_data: Option<ApplicationTag0<SignedData>>,
    //pub data: Asn1SetOf<Asn1RawDer>
}

//#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
//pub struct IgnoreImplicitSet(Asn1SetOf<Asn1RawDer>);

//impl Default for IgnoreImplicitSet {
//    fn default() -> Self {
//        Self(
//            Asn1SetOf::from(vec![Asn1RawDer(vec![0x30, 0x08, 0x0C, 0x03, 0x41, 0x62, 0x63, 0x02, 0x01, 0x05])])
//        )
//    }
//}

// fn implicit_field_is_default(wrapper: &Implicit<IgnoreImplicitSet>) -> bool {
//     wrapper.0 == IgnoreImplicitSet::default()
// }

#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
pub(crate) struct SignedData {
    pub version: u8,
    pub digest_algorithms: Asn1RawDer,
    pub encap_content_info: Asn1RawDer,
    pub certificates: Implicit<Option<ApplicationTag0<Asn1RawDer>>>,
    pub crls: Implicit<Option<ApplicationTag1<Asn1RawDer>>>,
    //pub signer_infos: Asn1RawDer,
    pub signer_infos: Asn1SetOf<Asn1RawDer>,
}


#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
pub(crate) struct SignerInfo {
    pub version: u8,
    pub sid: Asn1RawDer,
    pub digest_algorithm: Asn1RawDer,
    pub signed_attrs: Implicit<Option<HeaderOnly<ApplicationTag0<()>>>>,
    //pub signed_attrs: Asn1RawDer,
    pub signature_algorithm: Asn1RawDer,
    #[serde(with = "serde_bytes")]
    pub signature: Vec<u8>,
    pub unsigned_attrs: Implicit<Option<HeaderOnly<ApplicationTag1<()>>>>,
}

#[derive(Serialize, Deserialize, Clone, Debug, PartialEq)]
pub(crate) struct SignedAttr{
    pub object_identifier: ObjectIdentifierAsn1,
    pub signed_data: Asn1SetOf<Asn1RawDer>,
}



